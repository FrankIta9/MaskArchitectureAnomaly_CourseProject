# ============================================================================
# FROZEN BACKBONE + DECODER FINE-TUNING per Outlier Exposure
# OTTIMIZZATO per anomalie piccole (LostFound/fs_static) + Perspective-Aware Placement (ClimaOoD)
# ============================================================================
#
# STRATEGIA:
# - Backbone (ViT) CONGELATO → preserva feature semantiche Cityscapes
# - Solo decoder trainable (~10M params vs 95M) → fine-tuning leggero
# - LR moderato (3e-6) per stabilità con anomalie piccole
# - Training 10x più veloce, più stabile, zero rischio overfitting
#
# OTTIMIZZAZIONI APPLICATE (dopo risultati epoch 5):
# 1. ✅ Learning Rate: 5e-6 → 3e-6 (maggiore stabilità)
# 2. ✅ Paste probability: 0.20 → 0.18 (bilanciamento esposizione/stabilità)
# 3. ✅ Distribuzione pesata prioritizzata: 60% piccoli, 30% medi, 10% grandi (prima: 50/30/20)
# 4. ✅ Range piccoli: 0.01-0.05 → 0.02-0.06 (oggetti piccoli MA riconoscibili, 2-6% vs 1-5%)
# 5. ✅ coco_min_area: 1500 → 1000 (include più oggetti piccoli di qualità)
# 6. ✅ Perspective-Aware Placement (ClimaOoD): oggetti in basso = più grandi (realismo fisico)
# 7. ✅ Drivable Region Constraints (ClimaOoD): oggetti solo su road/sidewalk (coerenza spaziale)
# 8. ✅ mIoU monitorato: checkpoint salvati basati su metrics/val_iou_all (mIoU più alto = migliori risultati)
#
# RISULTATI EPOCH 5:
# - RoadObstacle21: AUPRC 89.83% (+3.02%), FPR@95TPR 0.48% (-7.18%) ✅ ECCELLENTE!
# - LostFound: AUPRC 18.06% (-0.52%) ❌ NESSUN MIGLIORAMENTO → ottimizzazioni applicate
# - fs_static: AUPRC 52.79% (-1.67%) ❌ PEGGIORATO → ottimizzazioni applicate
#
# VANTAGGI:
# 1. Mantiene mIoU Cityscapes (backbone frozen) → monitorato con metrics/val_iou_all (target: ~80-82%)
# 2. Decoder impara solo a riconoscere outliers COCO come "no object"
# 3. Priorità a anomalie piccole (LostFound/fs_static) → 60% oggetti piccoli (↑ da 50%)
# 4. Preserva RoadObstacle21 (anomalie grandi) → 10% oggetti grandi (già eccellente 89.83% AUPRC)
# 5. Perspective-Aware + Drivable Regions migliorano realismo (ispirato da ClimaOoD)
# 6. Range 0.02-0.06 evita oggetti troppo piccoli (~10px) non riconoscibili
# 7. Allineato con best practices OE (RbA paper) + ClimaOoD (perspective-aware placement)
#
# PARAMETRI TRAINABILI:
# - Scale blocks (cross-attention tra ViT e queries)
# - Learned queries (embeddings semantici)
# - Class head (classifica in-distribution vs "no object")
# - Mask head (genera maschere per ogni query)
#
# ============================================================================

trainer:
  max_epochs: 30  # Ridotto: convergenza più rapida con solo decoder
  
  # Batch size più grande possibile con decoder-only training
  accumulate_grad_batches: 1  # Effective = batch_size
  precision: "16-mixed"
  
  # Checkpoint su Google Drive
  # IMPORTANTE: Monitora mIoU (val_iou_all) perché mIoU più alto = migliori risultati anomaly detection
  # Con frozen backbone, mIoU dovrebbe essere preservato (~80-82% su Cityscapes val)
  # Se mIoU scende <75%, il modello sta disimparando → ferma training o riduci LR
  callbacks:
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        dirpath: "/content/drive/MyDrive/eomt_oe_frozen_backbone"
        filename: "eomt_frozen-{epoch:03d}-{metrics/ood_avg_auprc:.4f}"
        monitor: "metrics/ood_avg_auprc"  # Task 1A: Aggregated metric (avg of LostFound + fs_static)
        mode: "max"  # Salva checkpoint con AUPRC medio più alto
        save_top_k: 3  # Salva top 3 checkpoint per OOD performance
        save_last: true  # Salva sempre ultimo checkpoint
        save_weights_only: false  # IMPORTANTE: Salva anche optimizer state per permettere resume
        # Se save_weights_only=true, non puoi riprendere il training (solo pesi modello)
        # Se save_weights_only=false (default), puoi riprendere con --ckpt_path
        every_n_epochs: 1
    - class_path: lightning.pytorch.callbacks.EarlyStopping
      init_args:
        monitor: "metrics/ood_avg_auprc"  # Task 1A: Use aggregated metric
        mode: "max"
        patience: 5  # Stop if no improvement for 5 epochs
        min_delta: 0.0001  # Minimum change to qualify as improvement
  
  logger:
    class_path: lightning.pytorch.loggers.wandb.WandbLogger
    init_args:
      resume: allow
      project: "eomt"
      name: "OE_FrozenBackbone_lr3e6_LogitNorm_weightedScale60_PerspectiveAware_ClimaOoD_v2"

model:
  class_path: training.mask_classification_semantic.MaskClassificationSemantic
  init_args:
    # Pesi Cityscapes puliti (riparti da capo con distribuzione pesata)
    ckpt_path: "/content/drive/MyDrive/eomt_cityscapes.bin"
    # IMPORTANTE: Riparti da pesi Cityscapes puliti (non da epoch 16) per evitare disimparamento
    # Con distribuzione pesata + parametri conservativi, il training sarà più stabile
    
    attn_mask_annealing_enabled: True
    attn_mask_annealing_start_steps: [3317, 8292, 13268]
    attn_mask_annealing_end_steps: [6634, 11609, 16585]
    
    # ===== LR OTTIMIZZATO PER STABILITÀ E CONVERGENZA =====
    # 3e-6 = bilanciato per stabilità (ridotto da 5e-6 dopo risultati epoch 4)
    # MOTIVAZIONE:
    # - Frozen backbone → decoder può tollerare LR moderato (best practices: 1e-4 per decoder)
    # - Batch size ridotto (2 vs 6 config funzionante) → LR più basso compensa instabilità
    # - Energy Loss + Logit Norm + Perspective-Aware → 3e-6 è più stabile di 5e-6
    # - Energy warmup (epochs 0-9 disabled) → mitigazione instabilità iniziale
    # - Risultati epoch 4: LostFound 18.58% AUPRC → serve più stabilità per anomalie piccole
    # VALIDATO: config funzionante (RoadObstacle21 92%) aveva lr: 1e-6 con batch_size=6
    # Con batch_size=2 e anomalie piccole, 3e-6 è più appropriato per convergenza stabile
    lr: 3e-6
    llrd: 0.8  # Ignorato (backbone frozen), ma lasciato per compatibility
    
    # ===== ENERGY OOD CON WARMUP =====
    # Task 6: Adjusted schedule (start at epoch 0, warmup for 10 epochs)
    energy_ood_enabled: true
    energy_ood_max_weight: 0.001  # Reduced from 0.002 for stability
    energy_warmup_epochs: 10  # Task 6: Set to 10 (was 8)
    energy_warmup_start_epoch: 0  # Task 6: Start at epoch 0 (was 5)
    # Epochs 0-9: Energy warmup (gradually increases from 0)
    # Epochs 10+: Energy at full weight (0.001)
    max_epochs: 30
    
    # ===== LOGIT NORMALIZATION ENABLED =====
    # Normalizza logits per migliorare calibrazione anomaly scores
    # Task 3B: Reduced tau to avoid over-flattening logits
    logit_norm_enabled: true
    logit_norm_tau: 0.05  # Task 3B: Reduced from 0.07 to 0.05 (0.05-0.06 range)
    logit_norm_eps: 1e-6
    
    # ===== PARTIAL BACKBONE UNFREEZE =====
    # Unfreeze last 2 ViT blocks for fine-tuning
    lr_decoder: 3e-6  # LR for decoder/head/upscale params
    lr_backbone: 5e-7  # LR for unfrozen backbone blocks (lower than decoder)
    unfreeze_last_n_blocks: 2  # Unfreeze last 2 ViT blocks (out of 12 total)
    
    # ===== OOD VALIDATION DURING TRAINING =====
    # Lightweight validation on OOD datasets at each epoch end
    ood_lostfound_path: "/content/drive/MyDrive/datasets/FS_LostFound_full"
    ood_fsstatic_path: "/content/drive/MyDrive/datasets/fs_static"
    ood_val_num_samples: 40  # Number of images per dataset to evaluate (30-50)
    
    network:
      class_path: models.eomt.EoMT
      init_args:
        num_q: 100
        num_blocks: 3
        encoder:
          class_path: models.vit.ViT
          init_args:
            backbone_name: vit_base_patch14_reg4_dinov2

data:
  class_path: datasets.cityscapes_semantic_with_oe.CityscapesSemanticWithOE
  init_args:
    path: "/content/drive/MyDrive/Cityscapes"
    
    # Batch size ridotto per limiti memoria VRAM
    batch_size: 2  # Ridotto da 6 per limiti memoria (config funzionante aveva batch_size=6)
    num_workers: 8
    
    img_size: [1024, 1024]
    num_classes: 19
    color_jitter_enabled: true
    scale_range: [0.5, 2.0]
    check_empty_targets: true
    
    # ===== OUTLIER EXPOSURE OTTIMIZZATO =====
    coco_path: "/content/drive/MyDrive/coco2017_zips"
    coco_split: "train2017"  # Usa train2017 per più varietà (gestiamo noi la distribuzione pesata)
    # MOTIVAZIONE: Con distribuzione pesata multi-scale e coco_min_area=1500 (più alto),
    # train2017 (~500k oggetti) è perfetto per più varietà controllata
    # Compensiamo coco_min_area più alto (1500 vs 800) con più varietà train2017
    # Vantaggi: ~500k oggetti validi vs ~18k (val2017) → molto più varietà senza problemi di stabilità
    # Con 1 oggetto/batch al 15%, uso ~445 oggetti/epoch → train2017 evita ripetizioni e migliora learning
    use_coco_zip: true
    
    # ===== DISTRIBUZIONE PESATA MULTI-SCALE BILANCIATA =====
    # ANALISI PARAMETRI FUNZIONANTI (RoadObstacle21 92% AUPRC, FPR 0.51%):
    # - paste_probability: 0.15 ✅ (stesso del config funzionante)
    # - min_scale: 0.08, max_scale: 0.15 (uniforme) → NOI: distribuzione pesata per matchare anomalie diverse
    # - coco_min_area: 1500 ✅ (CRITICO! config funzionante aveva 1500, non 800!)
    # - coco_split: val2017 (config funzionante) → NOI: train2017 per più varietà (compensato con coco_min_area=1500)
    #
    # PROBLEMA IDENTIFICATO: RoadObstacle21 stava disimparando PRIMA della distribuzione pesata
    # - RoadObstacle21: anomalie GRANDI/MEDIE (10-40%) → FPR@95TPR passato da 0.51% a 10.98% (20x peggioramento!)
    # - fs_static/LostFound: anomalie PICCOLISSIME (1-5%) → basso AUPRC
    # - RoadAnomaly: anomalie MISTE (5-40%) → migliorato (+1.84%)
    #
    # CAUSE PROBABILI DEL DISIMPARAMENTO (storico, prima delle ottimizzazioni):
    # 1. min_scale/max_scale troppo piccoli (0.03/0.08) → TROPPO PICCOLI per RoadObstacle21
    # 2. coco_min_area troppo basso (600 vs 1500) → TROPPO BASSO, oggetti di bassa qualità ✅ CORRETTO: 1500
    # 3. train2017 SENZA distribuzione pesata → troppa varietà casuale senza controllo
    #
    # SOLUZIONE: Parametri OTTIMIZZATI per anomalie piccole (dopo risultati epoch 5)
    # ANALISI RISULTATI EPOCH 5:
    # - RoadObstacle21: AUPRC 86.81% → 89.83% (+3.02%) ✅ ECCELLENTE! FPR@95TPR 0.48% (migliorato!)
    # - LostFound: AUPRC 18.58% → 18.06% (-0.52%) ❌ NESSUN MIGLIORAMENTO
    # - fs_static: AUPRC 54.46% → 52.79% (-1.67%) ❌ PEGGIORATO
    # PROBLEMA: Range 0.01-0.05 troppo piccolo → oggetti 1% immagine (~10px) troppo piccoli per riconoscimento
    # SOLUZIONE: Bilanciare per includere oggetti piccoli MA riconoscibili
    #
    # - paste_probability: 0.18 (ridotto da 0.20) per ridurre confusione ✅ OTTIMIZZATO
    #   MOTIVAZIONE: 0.20 potrebbe essere troppo alto → confonde il modello
    #   Ridotto a 0.18 per bilanciare esposizione e stabilità (compromesso tra 0.15 e 0.20)
    # - coco_min_area: 1000 (ridotto da 1500) per includere più oggetti piccoli di qualità ✅ OTTIMIZZATO
    #   MOTIVAZIONE: 1500 filtra via oggetti piccoli validi → ridotto a 1000 per includere piccoli ma ben definiti
    #   COCO standard: Small <1024px, Medium 1024-9216px → 1000px è nella categoria Medium (qualità OK)
    # - Distribuzione pesata (60% piccoli, 30% medi, 10% grandi) PRIORITIZZA anomalie piccole ✅ OTTIMIZZATO
    #   MOTIVAZIONE: LostFound/fs_static hanno anomalie 1-5% → serve 60% oggetti piccoli (↑ da 50%)
    #   Ridotto grandi a 10% perché RoadObstacle21 già eccellente (89.83% AUPRC) → può tollerare meno grandi
    # - Scale ranges OTTIMIZZATI: [0.02, 0.06] per oggetti piccoli ma riconoscibili ✅ OTTIMIZZATO
    #   MOTIVAZIONE: Range 0.01-0.05 troppo piccolo (1% = ~10px) → aumentato a 0.02-0.06 (2-6% = ~20-60px)
    #   Evita oggetti troppo piccoli per riconoscimento, ma mantiene focus su anomalie piccole
    paste_probability: 0.18  # OTTIMIZZATO: ridotto da 0.20 per bilanciare esposizione e stabilità (LostFound 18.06% → target miglioramento)
    min_objects: 1
    max_objects: 1           # VALIDATO: stesso del config funzionante (più stabile)
    
    # Distribuzione pesata multi-scale PRIORITIZZATA per anomalie piccole (60% piccoli, 30% medi, 10% grandi)
    # OTTIMIZZATA dopo risultati epoch 5: LostFound 18.06% AUPRC, fs_static 52.79% AUPRC → serve più focus su piccoli
    # PRIORITÀ: 60% oggetti piccoli per matchare LostFound/fs_static (↑ da 50%)
    # RoadObstacle21 già eccellente (89.83% AUPRC) → può tollerare riduzione a 10% grandi (↓ da 20%)
    # IMPORTANTE: Range piccoli [0.02, 0.06] per oggetti piccoli MA riconoscibili (2-6% = ~20-60px a 1024x1024)
    # Evita range 0.01-0.05 che produce oggetti troppo piccoli (~10px) difficilmente riconoscibili
    use_weighted_scale: true  # Abilita distribuzione pesata prioritizzata per anomalie piccole
    scale_ranges:
      - [0.02, 0.06]   # Piccoli: 2-6% immagine (60% prob) ✅ OTTIMIZZATO: range [0.02, 0.06] per oggetti piccoli MA riconoscibili
        # MOTIVAZIONE: Range 0.01-0.05 troppo piccolo (1% = ~10px) → aumentato minimo a 0.02 (2% = ~20px)
        # Range 0.02-0.06 cattura oggetti piccoli (2-6% = ~20-60px) MA riconoscibili
        # LostFound/fs_static hanno anomalie 1-5% → range 0.02-0.06 è un buon compromesso
      - [0.05, 0.10]   # Medi: 5-10% immagine (30% prob) → matcha RoadAnomaly piccole/medie
      - [0.10, 0.30]   # Grandi: 10-30% immagine (10% prob) → PRESERVA RoadObstacle21 (già 89.83% AUPRC!)
        # Ridotto peso da 20% a 10% perché RoadObstacle21 già eccellente → più focus su piccoli
    scale_weights: [0.60, 0.30, 0.10]  # ✅ OTTIMIZZATO: 60% piccoli (↑ da 50%), 30% medi (stabile), 10% grandi (↓ da 20%)
    # MOTIVAZIONE: Risultati epoch 5 mostrano LostFound 18.06% AUPRC → serve 60% oggetti piccoli per convergenza
    # RoadObstacle21 già eccellente (89.83% AUPRC, FPR@95TPR 0.48%) → può tollerare riduzione a 10% grandi
    
    # Parametri legacy (ignorati se use_weighted_scale=true):
    min_scale: 0.08          # Ignorato se use_weighted_scale=true (valore originale funzionante)
    max_scale: 0.15          # Ignorato se use_weighted_scale=true (valore originale funzionante)
    coco_min_area: 1000      # OTTIMIZZATO: ridotto da 1500 per includere più oggetti piccoli di qualità
    # MOTIVAZIONE (risultati epoch 5): LostFound 18.06% AUPRC, fs_static 52.79% AUPRC → serve più oggetti piccoli
    # 1500 filtra via troppi oggetti piccoli validi → ridotto a 1000 per includere piccoli ma ben definiti
    # COCO standard: Small <1024px, Medium 1024-9216px, Large >9216px
    # 1000px è nella categoria "Medium" (qualità OK, non rumore) ✅
    # Trade-off: Include più oggetti piccoli ma mantiene qualità (1000px = ~31x31px a risoluzione media)
    # RoadObstacle21 già eccellente (89.83% AUPRC) → può tollerare leggera riduzione qualità oggetti grandi
    
    # ===== PERSPECTIVE-AWARE PLACEMENT (Ispirato da ClimaOoD) =====
    # Migliora il realismo fisico degli oggetti incollati
    # - Oggetti in basso (vicino alla camera) = più grandi
    # - Oggetti in alto (lontani) = più piccoli
    # Migliora il realismo rispetto a scale random, come nel paper ClimaOoD
    use_perspective_aware: true  # Abilita perspective-aware scaling (default: true)
    perspective_strength: 1.0    # Forza dell'effetto prospettiva (0.0 = disabilitato, 1.0 = massimo) (default: 1.0)
    
    # ===== DRIVABLE REGION CONSTRAINTS (Ispirato da ClimaOoD) =====
    # Posiziona oggetti solo su regioni "drivable" (road + sidewalk)
    # Evita di posizionare oggetti su cielo, edifici, vegetazione
    # Migliora la coerenza spaziale rispetto a posizione random, come nel paper ClimaOoD
    use_drivable_regions: true   # Abilita vincolo drivable regions (default: true)
    drivable_class_ids: [0, 1]   # Cityscapes train_id: 0=road, 1=sidewalk (default: [0, 1])
