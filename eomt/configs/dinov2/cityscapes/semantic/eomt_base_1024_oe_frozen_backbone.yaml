# ============================================================================
# FROZEN BACKBONE + DECODER FINE-TUNING per Outlier Exposure
# ============================================================================
#
# STRATEGIA:
# - Backbone (ViT) CONGELATO → preserva feature semantiche Cityscapes
# - Solo decoder trainable (~10M params vs 95M) → fine-tuning leggero
# - LR più alto (5e-5) possibile perché solo decoder cambia
# - Training 10x più veloce, più stabile, zero rischio overfitting
#
# VANTAGGI:
# 1. Mantiene 100% mIoU Cityscapes (backbone intatto)
# 2. Decoder impara solo a riconoscere outliers COCO come "no object"
# 3. Convergenza rapida (poche epochs sufficienti)
# 4. Allineato con best practices OE (RbA paper)
#
# PARAMETRI TRAINABILI:
# - Scale blocks (cross-attention tra ViT e queries)
# - Learned queries (embeddings semantici)
# - Class head (classifica in-distribution vs "no object")
# - Mask head (genera maschere per ogni query)
#
# ============================================================================

trainer:
  max_epochs: 30  # Ridotto: convergenza più rapida con solo decoder
  
  # Batch size più grande possibile con decoder-only training
  accumulate_grad_batches: 1  # Effective = batch_size
  precision: "16-mixed"
  
  # Checkpoint su Google Drive
  callbacks:
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        dirpath: "/content/drive/MyDrive/eomt_oe_frozen_backbone"
        filename: "eomt_frozen-{epoch:03d}-{metrics/val_iou_all:.4f}"
        monitor: "metrics/val_iou_all"
        mode: "max"
        save_top_k: 3
        save_last: true
        every_n_epochs: 1
  
  logger:
    class_path: lightning.pytorch.loggers.wandb.WandbLogger
    init_args:
      resume: allow
      project: "eomt"
      name: "OE_FrozenBackbone_lr1e6_LogitNorm_paste15_stable"

model:
  class_path: training.mask_classification_semantic.MaskClassificationSemantic
  init_args:
    # Pesi Cityscapes puliti
    ckpt_path: "/content/drive/MyDrive/eomt_cityscapes.bin"
    
    attn_mask_annealing_enabled: True
    attn_mask_annealing_start_steps: [3317, 8292, 13268]
    attn_mask_annealing_end_steps: [6634, 11609, 16585]
    
    # ===== LR ULTRA-CONSERVATIVO =====
    # 1e-6 = estremamente conservativo anche per decoder-only
    # Garantisce massima stabilità + compatibilità con logit_norm
    lr: 1e-6
    llrd: 0.8  # Ignorato (backbone frozen), ma lasciato per compatibility
    
    # ===== ENERGY OOD CON WARMUP =====
    # Conservativo per compatibilità con logit_norm
    energy_ood_enabled: true
    energy_ood_max_weight: 0.002  # Conservative (come ultraconservative)
    energy_warmup_epochs: 10  # Warmup medio (era 5)
    max_epochs: 30
    
    # ===== LOGIT NORMALIZATION ENABLED =====
    # Normalizza logits per migliorare calibrazione anomaly scores
    # Funzionava bene nei test precedenti
    logit_norm_enabled: true
    logit_norm_tau: 0.04
    logit_norm_eps: 1e-6
    
    network:
      class_path: models.eomt.EoMT
      init_args:
        num_q: 100
        num_blocks: 3
        encoder:
          class_path: models.vit.ViT
          init_args:
            backbone_name: vit_base_patch14_reg4_dinov2

data:
  class_path: datasets.cityscapes_semantic_with_oe.CityscapesSemanticWithOE
  init_args:
    path: "/content/drive/MyDrive/Cityscapes"
    
    # Batch size ridotto per limiti memoria VRAM
    batch_size: 2  # Ridotto da 6 per limiti memoria
    num_workers: 8
    
    img_size: [1024, 1024]
    num_classes: 19
    color_jitter_enabled: true
    scale_range: [0.5, 2.0]
    check_empty_targets: true
    
    # ===== OUTLIER EXPOSURE CONSERVATIVO =====
    coco_path: "/content/drive/MyDrive/coco2017_zips"
    coco_split: "val2017"
    use_coco_zip: true
    
    # Parametri OE ottimizzati per anomalie piccole (fs_static, RoadAnomaly)
    # PROBLEMA: fs_static (49% AUPRC) e RoadAnomaly (74% AUPRC) hanno anomalie PICCOLE (0.5-5%)
    # SOLUZIONE: Ridurre scala oggetti COCO per matchare anomalie piccole dei dataset di test
    # RoadAnomaly21: anomalie 0.5%-40% immagine (molte piccole <5%)
    # fs_static: oggetti Pascal VOC piccoli e complessi su Cityscapes
    paste_probability: 0.15  # 15% batch con outliers (conservativo per stabilità)
    min_objects: 1
    max_objects: 1           # Solo 1 oggetto per volta (più stabile)
    min_scale: 0.03          # Era 0.08 → Ridotto a 3% per includere anomalie piccole (0.5-5%)
    max_scale: 0.08          # Era 0.15 → Ridotto a 8% per matchare anomalie piccole ma ancora visibili
    coco_min_area: 800       # Era 1500 → Ridotto a 800 per includere oggetti più piccoli (ma ancora ben definiti)
